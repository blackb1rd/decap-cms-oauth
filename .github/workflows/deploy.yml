name: Deploy

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: read
  packages: read

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    environment: deployment
    steps:
      - name: Deploy to Server
        env:
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_PORT: ${{ secrets.DEPLOY_PORT }}
        run: |
          # Setup SSH
          SSH_KEY_PATH="$HOME/.ssh/id_ed25519"
          mkdir -p "$HOME/.ssh"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > "$SSH_KEY_PATH"
          chmod 600 "$SSH_KEY_PATH"

          # Safely escape secrets for the remote shell
          OAUTH_CLIENT_ID_ESCAPED=$(printf '%q' "${{ secrets.OAUTH_CLIENT_ID }}")
          OAUTH_SECRET_ESCAPED=$(printf '%q' "${{ secrets.OAUTH_SECRET }}")
          OAUTH_ORIGINS_ESCAPED=$(printf '%q' "${{ secrets.OAUTH_ORIGINS }}")
          GHCR_TOKEN_ESCAPED=$(printf '%q' "$GHCR_TOKEN")
          # DEPLOY_PORT must be provided as a repository secret. Fail early if missing.
          DEPLOY_PORT_ESCAPED=$(printf '%q' "$DEPLOY_PORT")
          if [ -z "$DEPLOY_PORT_ESCAPED" ]; then
            echo "error: DEPLOY_PORT secret is not set. Please configure repository secret DEPLOY_PORT." >&2
            exit 1
          fi
          DOCKER_PORT=$DEPLOY_PORT_ESCAPED

          # Pull the latest image and restart the service on the server
          ssh -i $SSH_KEY_PATH -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ secrets.SSH_USER_HOST }} " \
            echo $GHCR_TOKEN_ESCAPED | docker login ghcr.io -u ${{ github.actor }} --password-stdin && \
            docker pull ghcr.io/blackb1rd/decap-cms-oauth:latest && \
            docker stop decap-cms-oauth-app 2>/dev/null || true && \
            docker rm decap-cms-oauth-app 2>/dev/null || true && \
            docker run -d \
              --name decap-cms-oauth-app \
              --restart always \
              -p $DOCKER_PORT:$DOCKER_PORT \
              -e PORT=$DOCKER_PORT \
              -e ADDRESS=0.0.0.0 \
              -v /etc/ssl/certs:/etc/ssl/certs:ro \
              -e OAUTH_CLIENT_ID=$OAUTH_CLIENT_ID_ESCAPED \
              -e OAUTH_SECRET=$OAUTH_SECRET_ESCAPED \
              -e OAUTH_ORIGINS=$OAUTH_ORIGINS_ESCAPED \
              ghcr.io/blackb1rd/decap-cms-oauth:latest"
        shell: bash
